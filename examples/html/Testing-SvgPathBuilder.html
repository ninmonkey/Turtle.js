<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turtle.js</title>
    <link rel="stylesheet" href="./../css/main-grid.css" type="text/css">
    <link href="./../css/prism.css" rel="stylesheet" />
    <style>
        :root {
            /* --bg-primary-1: #2e353d; */
        }

        .inline-code-block {
            display: inline-block;
            padding: 0.2rem 0.4rem;
            background-color: var(--section-bg-color);
            border-radius: 3px;
            font-family: var(--font-sans);
            font-size: 0.9rem;
            color: var(--text-color);
            max-width: 180ch;
            margin: min(10vw, 30px) auto;
        }



    </style>
</head>

<body>
    <section>
        <nav>
            <ul>
                <li><a href="./">Go Back</a></li>
                <li><a href="#" id="cmd-btn-toggle-grid-large">Large / Small</a></li>
            </ul>
        </nav>
    </section>
    <section class="parent-context grid-small">
        <!-- <turtle-svg id="turtle-1" popovertarget="tooltip-1" popovertargetaction="toggle">
            <span slot="title">First</span>
        </turtle-svg> -->
    </section>

    <!-- shown when clicking '#button-bar button' -->
    <!--
    <div id="submenu-1" popover="auto">
        <button>Option A</button><br /><button>Option B</button>
    </div>
    -->

    <!-- element shown when hovering the "popovertarget" on "#button-bar button"-->
    <div id="tooltip-1" class="tooltip" popover="hint">Tooltip A</div>
    <!--
    Press the buttons to show the auto popovers. Hover or focus the buttons to show the hint popovers. When an auto popover is shown, you can show the hint popovers without hiding it.
    ex: https://developer.mozilla.org/en-US/docs/Web/API/Popover_API/Using#using_hint_popover_state
    -->

    <script type="module">
        import { Turtle } from './../../js/turtle.js';
        import { TurtleSvgElement } from './../../js/custom-element/turtle-svg-element.js';
        import { randomInt, elementFromIdOrValue, simpleFormatHtmlWhitespace, simpleEscapeHtml, ColorGenerator } from './../../js/utils.js'
        import { GetAllElements } from './../../js/debug_utils.js'
        import { SvgPathBuilder, Create_SvgPathElement, Create_SvgElement } from './../../js/svg.js'

        window.bag ??= {}

        const parentElement = document.querySelector( ".parent-context" )
        let cur
        const cg = new ColorGenerator( { mode: 'grayscale' } )

        function debug_InspectPathSize(  parent ) {
            /**
             * @description experiment to remove. inspect dynamic svg DOM
             **/
            const firstPath =  parent.querySelectorAll('svg path')[0]
            console.trace('debug_InspectPathSize', { firstPath, parent } )

            const info = { firstPath }

            if( firstPath ) {
                const owner = firstPath.ownerSVGElement

                info.bbox                     = firstPath.getBBox()
                info.owner                    = owner
                info.owner_BBox               = owner.getBBox()
                info.owner_ClientRects        = owner.getClientRects()
                info.owner_BoundingClientRect = owner.getBoundingClientRect()
                info.first_BBox               = firstPath.getBBox()
                info.first                    = firstPath.getClientRects()
            }
            console.log( info )
            window.bag.lastInspect = info
            return info
        }

        function NewPathSummary ( { title, path } ) {
            const elem = document.createElement( 'div' )
            if( path instanceof SvgPathBuilder === false ) {
                throw new TypeError( 'path must be an instance of SvgPathBuilder' )
            }
            const renderSvg = newSvgElement({ path: path, title: title })
            debug_InspectPathSize( renderSvg )
            window.bag.last_renderSvg = renderSvg


            elem.classList.add( 'newPath-summary' )
            elem.innerHTML = `
            <h3>${title}</h3>
            <code>
            ${ path.build() }
            </code>`
            // ${ renderSvg }
            // parentElement.appendChild( elem )
            parentElement.appendChild( renderSvg )
            return elem
        }

        function NewTurtle ( title ) {
            const elem = new TurtleSvgElement()
            const turt = elem.Turtle
            parentElement.appendChild( elem )
            elem.Title = title
            return turt
        }

        function CreateSvgContainerWithTooltip( options = {} ) {
            const config = {
                title: 'no title',
                id: 'svg-container-with-tooltip',
                path: null,
                ...options,
            }
            config.parentElement = document.querySelector( ".parent-context" )
                // parentElement: options.parentElement ?? document.querySelector( ".parent-context" ),
            const elem_root = document.createElement( 'div' )

            if( config.path == null ) {
                console.warn('no path provided, creating a default')
                const defaultPath = new SvgPathBuilder()
                    .moveTo( 0, 0 ).lineTo( 10, 0 )
                    .moveTo( 0, 0 ).lineTo( 0, 10  )
                    // .moveTo( 0, 0 )
                    .lineTo( 10, 10  )
                    .lineTo( 0, 10  )

                config.path = defaultPath
            }
            if( path instanceof SvgPathBuilder === false ) {
                throw new TypeError( 'path must be an instance of SvgPathBuilder' )
            }

            // const new_svg = newSvgElement({path: config.path, title: 'quick test'})
            const parentElement = document.querySelector( ".parent-context" )

            if( path instanceof SvgPathBuilder === false ) {
                throw new TypeError( 'path must be an instance of SvgPathBuilder' )
            }
            const renderSvg = newSvgElement({ path: config.path, title: 'ü¶ç ' +  config.title })
            config.parentElement.appendChild( renderSvg )
            // parentElement.appendChild( renderSvg )


            return elem_root


        //     const tmpTurt = new TurtleSvgElement()
        //     return tmpTurt
        //     const target = tmpTurt.getNamedElements().svg

        // //     const innerPathTemplate = `
        // //      <path
        // //     id             = 'turtle-path-test'
        // //     class          = 'svg-path'
        // //     fill           = 'hsl( 200 50% 50% )'
        // //     stroke         = 'currentColor'
        // //     stroke-width   = '1.5%'
        // //     stroke-linecap = 'round'
        // //     d = "${ options.path.build() }"
        // // ></path>
        // //     ```
        //     const one = newSvgElement( { path: null })
        //     target.outerHTML = svg.outerHTML
        //     return tmpTurt
        //     // tmpTurt.#context.outerHTML = o.outerHTML

            // const elem = newSvgElement({ path: path, title: title })
            // parentElement.appendChild( elem )
            // return elem

        }


        function newSvgElement( options  = {} ) {
            const config = {
                title: '',
                path: null, // new SvgPathBuilder(),
                stroke: null,
                ...options,
            }
            const wrapper_div = document.createElement( 'section' )
            wrapper_div.classList.add('svg-wrapper')

            const svgElem = Create_SvgElement(
                'svg',  {
                id     : 'turtle-svg-n',
                class  : 'svg-root',
                viewBox: '-10 -10 50 50',
                width  : '200px',
                height : '200px',
            })

            const pathElem = Create_SvgPathElement({
                id            : 'turtle-path-n',
                class         : 'svg-path',
                d             : config.path.build(),
                fill          : 'hsl( 200 50% 50% / .5)',
                stroke        : 'hsl( 180 70% 50% / .75)', // currentColor
                'stroke-width': '2.5%',
            })

            svgElem.appendChild( pathElem )
            wrapper_div.appendChild( svgElem )

            const renderTemplate = `
            <section class="svg-wrapper">
                <span class='svg-title'>${ config.title }</span>
            <!-- was
                width  = '100%'
                height = '100%' -->
            ${ wrapper_div.outerHTML }
                </section>`
            // wrapper_div.innerHTML = template

            // innerSvg = svgElem.outerHTML
            return wrapper_div
        }

        let i = 0
        let deg = 0
        let path // const newPath = new SvgPathBuilder()
        let curSummary
        let curSvgSource


        cur  = null
        path = new SvgPathBuilder()
        path
            .moveTo( 0, 0 ).lineTo( 10, 0 )
            .moveTo( 0, 0 ).lineTo( 0, 10  )
            // .moveTo( 0, 0 )
            .lineTo( 10, 10  )
            .lineTo( 0, 10  )

        curSvgSource = CreateSvgContainerWithTooltip( {
            title: 'now A',
            path,
            parentElement,
        } )

        path
            .lineTo( 30, 10 )

        curSvgSource = CreateSvgContainerWithTooltip( {
            title: 'now B',
            path,
            parentElement,
        } )

        console.trace('üß™ after creating paths')

        path = new SvgPathBuilder()
        path
            .moveTo( 10, 0 ).lineTo( 10, 10 )
            .lineTo( 0, 10  )


         curSvgSource = CreateSvgContainerWithTooltip( {
            title: 'now C',
            path,
            parentElement,
        } )

        curSummary = NewPathSummary({ title: 'Old: NewPathSummary', path })

        i = 0; deg =  0;
        cur = NewTurtle( 'old tooltip method' )
            .stroke( cg.Next )
            .stroke( cg.Next )
            .polygon( ( 1 + i++ ), 3 )
            .rotate( 90 * Math.PI / 180 )
            .polygon( ( 1 + i++ ), 3 )







        /* page specific handlers for `grid-example.html` */
        const toggleGridSizeButton = document.getElementById( "cmd-btn-toggle-grid-large" );
        toggleGridSizeButton.addEventListener( "click", () => {
            const target = document.querySelector( 'section.parent-context' )
            if ( target.classList.contains( "grid-large" ) ) {
                target.classList.replace( "grid-large", 'grid-small' )
            } else {
                target.classList.remove( "grid-small" )
                target.classList.add( "grid-large" )
            }
        } );
        // tooltips
        const tooltips = document.querySelectorAll( ".tooltip" );
        const btns = document.querySelectorAll( "#button-bar button" );

        function RegisterTooltipsForTurtleSvgElements ( turtleSvgElements ) {
            /**
             * @description Register hover tooltip for each TurtleSvgElement in the NodeList
             * @param {NodeListOf<TurtleSvgElement>} turtleSvgElements
             */

            turtleSvgElements.forEach( ( turtleSvgElem ) => {
                turtleSvgElem.addEventListener( "mouseover", () => {
                    const cur_tip = tooltips[ 0 ]
                    // let cur = turtleSvgElem.shadowRoot.querySelector( 'svg' )
                    const cur = turtleSvgElem.querySelector('svg')
                    const formatted_xml = simpleFormatHtmlWhitespace( cur.outerHTML )
                    const escaped_xml =
                        simpleEscapeHtml( formatted_xml )

                    const abbr_viewBox =
                        cur.getAttribute( 'viewBox' )
                            .split( /\s/ )
                            .map( ( s ) => new Number( s ).toFixed( 1 ) )
                            .join( ' ' )
                    const rawText = `
                    <p>
                    Viewbox: ${ abbr_viewBox }
                    <br/>X, Y: ${ cur.getAttribute( 'x' ) }, ${ cur.getAttribute( 'y' ) }.
                    <br/>Width, Height (attr):d ${ cur.getAttribute( 'width' ) } x ${ cur.getAttribute( 'height' ) }
                    <br/>BaseVal: ${ cur.width.baseVal.value.toFixed( 1 ) } x ${ cur.height.baseVal.value.toFixed( 1 ) }
                    </p>
                    <p>Svg:</p><pre class="inline-code-block"><code class="language-xml">${ escaped_xml
                        }</code></pre>`
                    cur_tip.innerHTML = rawText

                    window.Prism.highlightAll()
                    cur_tip.showPopover( { source: turtleSvgElem } );
                } );

                turtleSvgElem.addEventListener( "mouseout", () => {
                    const cur_tip = tooltips[ 0 ]
                    cur_tip.hidePopover();
                } );

                turtleSvgElem.addEventListener( "focus", () => {
                    const cur_tip = tooltips[ 0 ]
                    cur_tip.showPopover( { source: turtleSvgElem } );
                } );

                turtleSvgElem.addEventListener( "blur", () => {
                    const cur_tip = tooltips[ 0 ]
                    cur_tip.hidePopover();
                } )

                turtleSvgElem.addEventListener( "click", () => {
                    const cur_tip = tooltips[ 0 ]
                    // const rawSvgText = turtleSvgElem.getNamedElements().svg.outerHTML
                    const rawSvgText = turtleSvgElem.querySelector('svg').outerHTML
                    console.info( 'copied SVG to clipboard', { rawSvgText } )
                    navigator.clipboard.writeText( rawSvgText )
                        .catch( err => {
                            console.error( 'Failed to copy SVG to clipboard:', err );
                        } )
                } )
            } )
        }

        // const all_turtle_elements = document.querySelectorAll( 'turtle-svg' )
        // RegisterTooltipsForTurtleSvgElements( all_turtle_elements )

        const all_wrappers = document.querySelectorAll('.svg-wrapper')
        RegisterTooltipsForTurtleSvgElements( all_wrappers )

        // globals
        window.bag ??= {}
        window.fn ??= {}
        window.Turtle = Turtle
        window.TurtleSvgElement = TurtleSvgElement
        window.bag.root_elem = parentElement
        window.bag.all_wrappers = all_wrappers

        // window.t1 = turt
        // window.t3 = dest
        window.dbg_all = GetAllElements

        window.fn.pathSize = debug_InspectPathSize

        console.trace( 'debug enabled globals: ', { Turtle, TurtleSvgElement, bag } )
        console.log('try funcs')
        let t = document.querySelectorAll('svg')[0]
        fn.pathSize( t )

    </script>
    <script src="../../js/prism.js"></script>


</body>

</html>